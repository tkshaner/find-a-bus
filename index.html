<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Find A Bus</title>
    <script>
      (function () {
        try {
          const storageKey = "findabus-theme";
          const storedTheme = window.localStorage.getItem(storageKey);
          const prefersDarkQuery = typeof window.matchMedia === "function"
            ? window.matchMedia("(prefers-color-scheme: dark)")
            : null;
          const prefersDark = prefersDarkQuery ? prefersDarkQuery.matches : false;
          const theme = storedTheme || (prefersDark ? "dark" : "light");
          document.documentElement.setAttribute("data-theme", theme);
        } catch (error) {
          document.documentElement.setAttribute("data-theme", "light");
        }
      })();
    </script>
    <link rel="stylesheet" href="styles.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  </head>
  <body>
    <header class="hero">
      <div class="hero__toolbar">
        <button type="button" id="themeToggle" class="theme-toggle" aria-pressed="false">
          <span class="theme-toggle__icon" data-theme-icon aria-hidden="true">üåû</span>
          <span class="theme-toggle__label" data-theme-label>Light mode</span>
        </button>
      </div>
      <div class="hero__content">
        <h1>TheBus Route & Vehicle Explorer</h1>
        <p>
          Discover Honolulu bus routes, live vehicle positions, and stop arrivals using
          <a href="https://api.thebus.org" target="_blank" rel="noopener">TheBus API</a>.
          Enter your API key and search parameters below to get started.
        </p>

        <div class="security-notice" role="alert">
          <strong>‚ö†Ô∏è Security Notice:</strong> Your API key is stored in your browser. By default, it's cleared when you close the tab.
          Never use production or paid API keys with this tool.
          <a href="https://www.honolulutransit.org/" target="_blank" rel="noopener">Get a free developer key</a>.
        </div>

        <div class="api-key-container">
          <label class="input-group" for="apiKey">
            <span>API Key</span>
            <div class="input-with-controls">
              <input id="apiKey" type="password" autocomplete="off" placeholder="Enter your TheBus API key" aria-describedby="key-help" />
              <button type="button" id="toggleKeyVisibility" class="btn-icon" aria-label="Toggle API key visibility" title="Show/Hide key">
                <span class="icon-eye" aria-hidden="true">üëÅÔ∏è</span>
              </button>
              <button type="button" id="clearKey" class="btn-icon" aria-label="Clear API key" title="Clear key">
                <span class="icon-clear" aria-hidden="true">‚úï</span>
              </button>
            </div>
          </label>
          <small id="key-help" class="help-text">Your key is stored temporarily in this browser session</small>

          <label class="checkbox-group">
            <input type="checkbox" id="rememberKey" />
            <span>Remember my key (stores permanently in browser)</span>
          </label>
        </div>
      </div>
    </header>

    <main>
      <section class="panel" aria-labelledby="stops-map-title">
        <div class="panel__header">
          <h2 id="stops-map-title">All Bus Stops</h2>
          <p>Browse all 3,825+ TheBus stops across Oahu. Click any stop to see upcoming arrivals.</p>
        </div>
        <div class="map-controls">
          <button type="button" id="toggleStopsBtn" class="btn">Show All Stops on Map</button>
          <button type="button" id="findNearbyBtn" class="btn btn-secondary" style="display: none;">Find Stops Near Me</button>
        </div>
        <div id="stopsMap" class="map-container" style="display: none;">
          <div id="stopsMapCanvas" class="map-canvas" style="height: 500px;"></div>
        </div>
        <div id="stopsMessage" class="info-message" style="display: none;"></div>
      </section>

      <section class="panel" aria-labelledby="routes-title">
        <div class="panel__header">
          <h2 id="routes-title">Find Routes</h2>
          <p>Search for routes by number and optional headsign keyword.</p>
        </div>
        <form id="routeForm" class="form-grid">
          <label class="input-group" for="routeNumber">
            <span>Route Number</span>
            <input id="routeNumber" name="route" type="text" placeholder="e.g. 2" required />
          </label>
          <label class="input-group" for="routeHeadsign">
            <span>Headsign (optional)</span>
            <input id="routeHeadsign" name="headsign" type="text" placeholder="e.g. HAWAII KAI" />
          </label>
          <button type="submit" class="btn">Search Routes</button>
        </form>
        <div id="routeVariantSelector" style="display: none; margin: 1rem 0;">
          <label class="input-group" for="variantSelect">
            <span>Route Variant</span>
            <select id="variantSelect" class="variant-select">
              <!-- Options populated dynamically -->
            </select>
          </label>
        </div>
        <div id="routeMap" class="map-container" style="display: none;">
          <div id="routeMapCanvas" class="map-canvas"></div>
        </div>
        <div id="routeResults" class="results" role="status" aria-live="polite"></div>
      </section>

      <section class="panel" aria-labelledby="vehicle-title">
        <div class="panel__header">
          <h2 id="vehicle-title">Track a Vehicle</h2>
          <p>Enter a bus number to view its latest position, route, and schedule adherence.</p>
        </div>
        <form id="vehicleForm" class="form-grid">
          <label class="input-group" for="vehicleNumber">
            <span>Vehicle Number</span>
            <input id="vehicleNumber" name="num" type="text" placeholder="e.g. 249" required />
          </label>
          <button type="submit" class="btn">Get Vehicle Info</button>
        </form>
        <div id="vehicleMap" class="map-container" style="display: none;">
          <div id="vehicleMapCanvas" class="map-canvas"></div>
        </div>
        <div id="vehicleResults" class="results" role="status" aria-live="polite"></div>
      </section>

      <section class="panel" aria-labelledby="arrivals-title">
        <div class="panel__header">
          <h2 id="arrivals-title">Check Stop Arrivals</h2>
          <p>See upcoming arrivals for a stop to plan your trip.</p>
        </div>
        <form id="arrivalsForm" class="form-grid">
          <label class="input-group" for="stopNumber">
            <span>Stop Number</span>
            <input id="stopNumber" name="stop" type="text" placeholder="e.g. 1" required />
          </label>
          <button type="submit" class="btn">View Arrivals</button>
        </form>
        <div id="arrivalsResults" class="results" role="status" aria-live="polite"></div>
      </section>

      <section class="panel panel--info">
        <h2>Usage Tips</h2>
        <ul>
          <li>Create a free API key at <a href="https://www.honolulutransit.org/" target="_blank" rel="noopener">TheBus developer site</a>.</li>
          <li>The <code>headsign</code> filter on routes is currently limited, so try searching with only the route number first.</li>
          <li>Vehicle latitude/longitude values can be plotted on a map app to see the precise location.</li>
        </ul>
      </section>
    </main>

    <template id="route-template">
      <article class="card">
        <h3>Route <span data-field="routeNum"></span></h3>
        <dl>
          <div><dt>Headsign</dt><dd data-field="headsign"></dd></div>
          <div><dt>First Stop</dt><dd data-field="firstStop"></dd></div>
          <div><dt>Shape ID</dt><dd data-field="shapeID"></dd></div>
        </dl>
      </article>
    </template>

    <template id="vehicle-template">
      <article class="card">
        <h3>Vehicle <span data-field="number"></span></h3>
        <dl>
          <div><dt>Route</dt><dd data-field="route_short_name"></dd></div>
          <div><dt>Headsign</dt><dd data-field="headsign"></dd></div>
          <div><dt>Adherence</dt><dd data-field="adherence"></dd></div>
          <div><dt>Driver</dt><dd data-field="driver"></dd></div>
          <div><dt>Last Update</dt><dd data-field="last_message"></dd></div>
          <div><dt>Latitude</dt><dd data-field="latitude"></dd></div>
          <div><dt>Longitude</dt><dd data-field="longitude"></dd></div>
          <div><dt>Trip</dt><dd data-field="trip"></dd></div>
        </dl>
      </article>
    </template>

    <template id="arrival-template">
      <article class="card">
        <h3><span data-field="route"></span> &mdash; <span data-field="headsign"></span></h3>
        <dl>
          <div><dt>Scheduled</dt><dd data-field="stopTime"></dd></div>
          <div><dt>Estimated</dt><dd data-field="estimated"></dd></div>
          <div><dt>Vehicle</dt><dd data-field="vehicle"></dd></div>
          <div><dt>Direction</dt><dd data-field="direction"></dd></div>
          <div><dt>Status</dt><dd data-field="canceled"></dd></div>
        </dl>
      </article>
    </template>

    <script src="app.js" type="module"></script>
  </body>
</html>
